# ---------------------------------------------------------
# 1. GLOBAL OPTIONS & SNIPPETS
# ---------------------------------------------------------

{
    admin off
    persist_config off
    auto_https off
    log {
        format json
    }
    servers {
        trusted_proxies static private_ranges
    }
}

(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# ---------------------------------------------------------
# 2. SITE CONFIGURATION
# ---------------------------------------------------------

:{$PORT} {
    log {
        format json
    }

    # --- RULE 1: Identity Service API (Unprotected) ---
    handle_path {$IDENTITY_SERVICE_PATH:/api/auth}/* {
        reverse_proxy {
            dynamic a {
                name {$IDENTITY_SERVICE_DOMAIN}
                port {$IDENTITY_SERVICE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # --- RULE 2: Data Bridge API (Unprotected) ---
    handle_path {$DATA_BRIDGE_PATH:/api/bridge}/* {
        reverse_proxy {
            dynamic a {
                name {$DATA_BRIDGE_DOMAIN}
                port {$DATA_BRIDGE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # --- RULE 3: Socket.IO (WebSocket) to Data Bridge ---
    handle_path /socket.io* {
        reverse_proxy {
            dynamic a {
                name {$DATA_BRIDGE_DOMAIN}
                port {$DATA_BRIDGE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }

    # --- RULE 4: Frontend SPA (Protected) ---
    handle {
        basicauth {
            # Remember: variable BASIC_AUTH_PASS must be a BCRYPT HASH
            {$BASIC_AUTH_USER} {$BASIC_AUTH_PASS}
        }

        reverse_proxy {
            dynamic a {
                name {$FRONTEND_DOMAIN}
                port {$FRONTEND_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {upstream_hostport}
        }
    }
}

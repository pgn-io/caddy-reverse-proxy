# ---------------------------------------------------------
# 1. GLOBAL OPTIONS & SNIPPETS
# ---------------------------------------------------------

{
    admin off
    persist_config off
    auto_https off

    log {
        format json
    }

    servers {
        trusted_proxies static private_ranges
    }
}

(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# ---------------------------------------------------------
# 2. SITE CONFIGURATION
# ---------------------------------------------------------

:{$PORT} {
    log {
        format json
    }

    route {

        # -------------------------
        # Data-bridge
        # -------------------------

        # /api/bridge/*
        handle_path {$DATA_BRIDGE_PATH:/api/bridge}/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # /api/trpc/*
        # Use handle so the upstream sees /api/trpc...
        handle {$DATA_BRIDGE_TRPC_PATH:/api/trpc}/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # /socket.io/*
        # Use handle so /socket.io is not stripped.
        handle /socket.io/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Identity service (catch-all for the rest of /api)
        # -------------------------
        # This prevents HTML SPA fallback for endpoints like:
        # /api/profile
        # /api/session
        # /api/users
        # /api/twitter
        # /api/telegram
        #
        # NOTE: handle_path strips /api before proxying.
        handle_path {$IDENTITY_SERVICE_API_PATH:/api}/* {
            reverse_proxy {
                dynamic a {
                    name {$IDENTITY_SERVICE_DOMAIN}
                    port {$IDENTITY_SERVICE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Frontend SPA fallback
        # -------------------------
        handle {
            reverse_proxy {
                dynamic a {
                    name {$FRONTEND_DOMAIN}
                    port {$FRONTEND_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }
    }
}

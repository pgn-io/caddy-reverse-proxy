# ---------------------------------------------------------
# 1. GLOBAL OPTIONS & SNIPPETS
# ---------------------------------------------------------

{
    admin off
    persist_config off
    auto_https off

    log {
        format json
    }

    servers {
        trusted_proxies static private_ranges
    }
}

# Snippet: Load Balancing Settings
(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

# Snippet: Passive Health Checks
(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# ---------------------------------------------------------
# 2. SITE CONFIGURATION
# ---------------------------------------------------------

:{$PORT} {
    log {
        format json
    }

    route {
        # -------------------------
        # Identity service (default /api/*, no prefix stripping)
        # -------------------------
        handle {$IDENTITY_SERVICE_PATH:/api}/* {
            reverse_proxy {
                dynamic a {
                    name {$IDENTITY_SERVICE_DOMAIN}
                    port {$IDENTITY_SERVICE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Data-bridge HTTP endpoints (strip /api/bridge)
        # -------------------------
        handle_path {$DATA_BRIDGE_PATH:/api/bridge}/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # tRPC (keep /api/trpc)
        # -------------------------
        handle {$DATA_BRIDGE_TRPC_PATH:/api/trpc}/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Socket.IO (keep /socket.io)
        # -------------------------
        handle /socket.io/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Frontend SPA with basic auth on HTML routes only
        # -------------------------
        @assets {
            path /assets/* /favicon.ico /logo.svg /manifest.json /robots.txt
            path_regexp static \.(js|css|map|png|jpg|jpeg|gif|svg|webp|ico)$
        }

        handle @assets {
            reverse_proxy {
                dynamic a {
                    name {$FRONTEND_DOMAIN}
                    port {$FRONTEND_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        handle {
            @auth_any {
                not {
                    path /api/*
                    path /assets/* /favicon.ico /logo.svg /manifest.json /robots.txt
                    path_regexp static \.(js|css|map|png|jpg|jpeg|gif|svg|webp|ico)$
                }
            }
            basicauth @auth_any {
                {$BASIC_AUTH_USER} {$BASIC_AUTH_PASS}
            }
            reverse_proxy {
                dynamic a {
                    name {$FRONTEND_DOMAIN}
                    port {$FRONTEND_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }
    }
}

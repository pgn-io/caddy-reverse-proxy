# ---------------------------------------------------------
# 1. GLOBAL OPTIONS & SNIPPETS
# ---------------------------------------------------------

# Global options
{
    admin off
    persist_config off
    auto_https off
    log {
        format json
    }
    servers {
        trusted_proxies static private_ranges
    }
}

# Snippet: Load Balancing Settings
(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

# Snippet: Passive Health Checks
(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# ---------------------------------------------------------
# 2. SITE CONFIGURATION
# ---------------------------------------------------------

:{$PORT} {
    log {
        format json
    }

    # --- Socket.IO (Data Bridge) ---
    handle /socket.io/* {
        reverse_proxy {
            dynamic a {
                name {$DATA_BRIDGE_DOMAIN}
                port {$DATA_BRIDGE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks

            header_up Host {host}
        }
    }

    handle /api/trpc* {
        reverse_proxy {
        dynamic a {
            name {$DATA_BRIDGE_DOMAIN}
            port {$DATA_BRIDGE_PORT}
            refresh 1s
            dial_timeout 30s
            versions ipv4 ipv6
        }
        import lb_settings
        import passive_health_checks
        header_up Host {host}
        }
    }

    # --- Internal Services ---
    handle /api/auth/* {
        reverse_proxy {
            dynamic a {
                name {$IDENTITY_SERVICE_DOMAIN}
                port {$IDENTITY_SERVICE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {host}
        }
    }

    # Profile exact
    handle /api/profile {
        uri strip_prefix /api
        reverse_proxy {
            dynamic a {
                name {$IDENTITY_SERVICE_DOMAIN}
                port {$IDENTITY_SERVICE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {host}
        }
    }

    # Profile subroutes
    handle /api/profile/* {
        uri strip_prefix /api
        reverse_proxy {
            dynamic a {
                name {$IDENTITY_SERVICE_DOMAIN}
                port {$IDENTITY_SERVICE_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {host}
        }
    }

    # --- Frontend (fallback) ---
    handle {
        reverse_proxy {
            dynamic a {
                name {$FRONTEND_DOMAIN}
                port {$FRONTEND_PORT}
                refresh 1s
                dial_timeout 30s
                versions ipv4 ipv6
            }
            import lb_settings
            import passive_health_checks
            header_up Host {host}
        }
    }
}
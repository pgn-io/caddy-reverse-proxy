# ---------------------------------------------------------
# 1. GLOBAL OPTIONS & SNIPPETS
# ---------------------------------------------------------

{
    admin off
    persist_config off
    auto_https off

    log {
        format json
    }

    servers {
        trusted_proxies static private_ranges
    }
}

# Snippet: Load Balancing Settings
(lb_settings) {
    lb_policy round_robin
    lb_retries 100
    lb_try_duration 10s
    lb_try_interval 250ms
}

# Snippet: Passive Health Checks
(passive_health_checks) {
    fail_duration 60s
    max_fails 300
    unhealthy_latency 5s
    unhealthy_request_count 200
}

# ---------------------------------------------------------
# 2. SITE CONFIGURATION
# ---------------------------------------------------------

:{$PORT} {
    log {
        format json
    }

    # Control matching order explicitly.
    route {

        # -------------------------
        # Identity service
        # -------------------------
        # Default path: /api/auth/*
        # handle_path strips the prefix before proxying.
        handle_path {$IDENTITY_SERVICE_PATH:/api/auth}/* {
            reverse_proxy {
                dynamic a {
                    name {$IDENTITY_SERVICE_DOMAIN}
                    port {$IDENTITY_SERVICE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Data-bridge HTTP endpoints
        # -------------------------
        # Default path: /api/bridge/*
        handle_path {$DATA_BRIDGE_PATH:/api/bridge}/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # tRPC
        # -------------------------
        # Frontend calls /api/trpc/*
        # Use handle (NOT handle_path) so /api/trpc is not stripped.
        handle {$DATA_BRIDGE_TRPC_PATH:/api/trpc}/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Socket.IO
        # -------------------------
        # Use handle (NOT handle_path) so /socket.io is not stripped.
        handle /socket.io/* {
            reverse_proxy {
                dynamic a {
                    name {$DATA_BRIDGE_DOMAIN}
                    port {$DATA_BRIDGE_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }

        # -------------------------
        # Frontend SPA fallback
        # -------------------------
        handle {
            reverse_proxy {
                dynamic a {
                    name {$FRONTEND_DOMAIN}
                    port {$FRONTEND_PORT}
                    refresh 1s
                    dial_timeout 30s
                    versions ipv4 ipv6
                }
                import lb_settings
                import passive_health_checks
                header_up Host {upstream_hostport}
            }
        }
    }
}
